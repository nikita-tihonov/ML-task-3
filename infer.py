import torch

from preprocessing import DEVICE, word_field, BucketIterator, train_dataset
from model import EncoderDecoder

def summarize_text(model, text, word_field, max_length=100):
    text_field = [word_field.preprocess(text)]
    indexed_input = word_field.process(text_field).to(DEVICE)

    source_inputs = indexed_input.transpose(0, 1)
    source_mask = (source_inputs != word_field.vocab.stoi['<pad>']).unsqueeze(-2)
    summary_ids = model.generate_summary(source_inputs, source_mask, max_length=max_length)
    summary_text = ' '.join([word_field.vocab.itos[idx] for idx in summary_ids[0][0].cpu().numpy() if
                             idx not in [word_field.vocab.stoi['<pad>'], word_field.vocab.stoi['<s>'],
                                         word_field.vocab.stoi['</s>']]])
    return summary_text


texts = [
        "Гражданку России Марию Бутину задержали в Вашингтоне по подозрению в шпионаже. Об этом говорится в сообщении Министерства юстиции США. Ее обвиняют в сговоре с целью работы агентом иностранного государства без соответствующей регистрации при американском правительстве. По информации министерства, Бутина была задержана 15 июля. Суд округа Колумбия принял решение оставить ее под стражей до слушаний, которые пройдут 18 июля. По информации обвинения, задержанная работала по распоряжению высокопоставленного официального лица российского правительства, который находится под санкциями США. Ей грозит до пяти лет тюрьмы. Глава комитета Совета Федерации по международным делам Константин Косачев заявил РИА Новости, что Россия будет защищать Бутину, если подтвердится ее российское гражданство.",
        "Футболисты сборной Франции ворвались на послематчевую пресс-конференцию главного тренера Дидье Дешама после победы над Хорватией в финале чемпионата мира-2018. Видео опубликовал в Twitter-аккаунте спортивный журналист Василий Конов. Футболисты отпраздновали победу прямо во время мероприятия. Защитник Бенджамен Менди, в частности, забрался на стол, за которым сидел Дешам, и облил наставника водой. Французы переиграли хорватов в финальном матче чемпионата мира-2018. Встреча завершилась со счетом 4:2 в пользу команды Дешама.",
        "Нападающий сборной Франции Килиан Мбаппе отказался от денег, заработанных в составе национальной команды на чемпионате мира-2018, и передал их на благотворительность. Об этом сообщается в Twitter-аккаунте FourFourTweet. Общая сумма премиальных форварда на турнире составила 550 тысяч долларов. Его пожертвование пойдет на нужды детей-инвалидов. 15 июля в финале чемпионата мира сборная Франции обыграла команду Хорватии (4:2), Мбаппе стал автором одного из голов. Всего на мировом первенстве 19-летний нападающий забил четыре мяча и был признан лучшим молодым игроком турнира. Мбаппе выступает за французский «Пари Сен-Жермен». Он перешел в состав парижан летом 2017 года из «Монако» за 180 миллионов евро. Годовая зарплата форварда в клубе составляет 18 миллионов евро.",
        "Сотрудники музея в городе Киль, Германия, запустили двигатель от немецкой субмарины времен Второй мировой войны. На ролик, опубликованный на YouTube, обратил внимание пользователь портала Pikabu. Как отмечается, 6-цилиндровый двигатель RS 34 S изначально проектировался как дизель-генератор для линкоров «Бисмарк» и «Тирпиц». Позже его начали использовать на подводных лодках типа XXIII. Двигатель имеет объем 108 литров (18 литров на каждый цилиндр) и мощность 576 лошадиных сил при 850 оборотах в минуту. Подводные лодки типа XXIII — серия немецких малых подводных лодок, построенных в 1943-1945 годах. Всего по данному проекту была создана 61 субмарина, из них войну пережили только три подлодки.",
        "Российский МИД отреагировал на критику лидеров стран-членов НАТО, которые обвинили Москву в нарушении международного законодательства и провокациях. Сообщение размещено в официальном Twitter министерства. «Пока бесполезный военный блок НАТО обвиняет нас в провокационной деятельности и продолжает скрежетать зубами в Брюсселе, мы готовимся смотреть ЧМ-2018», — говорится в заявлении. Ранее 11 июля НАТО  опубликовало декларацию, в которой критикует Москву за дестабилизацию ситуации на Украине, размещение ракет в Калининграде, нарушение пространства стран НАТО, попытку вмешательства в дела других стран и использование кибератак и дезинформации. Матч полуфинала чемпионата мира между сборными Англии и Хорватии проходит в Москве на стадионе «Лужники».",
        "Президент Владимир Путин за несколько суток до встречи с американским лидером Дональдом Трампом прибыл на Валаам в день памяти основателей Спасо-Преображенского Валаамского монастыря преподобных Сергия и Германа. Об этом сообщает РИА Новости в среду, 11 июля. Глава государства регулярно приезжает на Валаам. Год назад он также побывал на молебне в день церковного празднования памяти преподобных Сергия и Германа. В июле прошлого года Путин пробыл в монастыре несколько дней. Остров Валаам находится на Ладожском озере. На нем расположен одноименный поселок, а также памятник русского зодчества — Валаамский ставропигиальный мужской монастырь.",
        "Депутата Госдумы и главу комитета по экономической политике Сергея Жигарева (фракция «ЛДПР») избили на севере Москвы. Парламентария доставили в больницу, сообщает в понедельник, 9 июля, РЕН ТВ. Отмечается, что у Жигарева диагностированы гематома, закрытая черепно-мозговая травма и кровоподтеки. Врачи подозревали перелом челюсти, но травма не подтвердилась. Инцидент произошел на улице Полины Осипенко вечером 8 июля. Как передает телеканал, от госпитализации депутат отказался. В декабре 2016-го Жигарев был избран депутатом Госдумы седьмого созыва по Щелковскому одномандатному избирательному округу. Назначен на должность председателя комитета по экономической политике, промышленности, инновационному развитию и предпринимательству. Включен в состав Межведомственной комиссии Совета Безопасности России по военной безопасности.",
        "В Нигерии погиб колдун, решивший испытать амулет, который отводит пули. Об этом сообщает BBC News. Чтобы продемонстрировать действенность своей магии, 26-летний знахарь Чинака Адоэзуве (Chinaka Adoezuwe) надел на шею амулет, который он изготовил, протянул покупателю оружие и велел выстрелить в него. Амулет не сработал, и знахарь погиб от огнестрельного ранения. Покупатель арестован, его подозревают в убийстве. BBC News отмечает, что это не первый случай гибели людей, пытавшихся убедиться в эффективности популярных в Нигерии амулетов и снадобий для защиты от пуль. В 2017 году сообщалось, что в Индонезии крокодил убил заклинателя крокодилов. Рептилия утащила его под воду, когда он вошел в реку и принялся читать мантры.",
        "Рекорд скорости советской подводной лодки К-162 (проекта 661 «Анчар»), установленный в 1970 году, до сих пор не побит ни одной субмариной в мире, следует из материалов Книги рекордов Вооруженных сил России, опубликованных на сайте Минобороны. «Подводная лодка К-162 661-го проекта на испытаниях 18 декабря 1970 года установила мировой рекорд скорости подводного хода — 44,7 узла (более 80 километров в час — прим. «Ленты.ру»). До настоящего времени этот рекорд не превзойден», — говорится в публикации. В настоящее время самые современные субмарины развивают подводную скорость около 30 узлов (более 55 километров в час). Подлодка К-162, выполненная из титана, получила прозвище «Золотая рыбка»."
        ]
model = EncoderDecoder(source_vocab_size=53879, target_vocab_size=53879).to(DEVICE)
model.load_state_dict(torch.load('trained_model.pt', map_location=torch.device('cpu')), strict=False)
model.eval()
for text in texts:
    summary = summarize_text(model, text, word_field, max_length=20)
    print("Summary:", summary[6:].capitalize() + '.')